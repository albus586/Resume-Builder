{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center animate__animated animate__fadeIn">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h2 class="mb-0"><i class="fas fa-tasks me-2"></i>Todo List</h2>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <form id="add-todo-form" class="d-flex">
                            <input type="text" id="new-todo" class="form-control me-2" placeholder="Enter a new task..."
                                required>
                            <button type="submit" class="btn btn-info text-white">
                                <i class="fas fa-plus me-1"></i> Add
                            </button>
                        </form>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary" id="filter-all">All</button>
                            <button type="button" class="btn btn-outline-secondary" id="filter-active">Active</button>
                            <button type="button" class="btn btn-outline-secondary"
                                id="filter-completed">Completed</button>
                        </div>
                    </div>
                </div>

                <ul class="list-group" id="todo-list">
                    {% for todo in todos %}
                    <li class="list-group-item d-flex justify-content-between align-items-center todo-item"
                        data-id="{{ todo.id }}">
                        <div>
                            <input class="form-check-input me-2 todo-checkbox" type="checkbox" {% if todo.completed
                                %}checked{% endif %}>
                            <span class="todo-text {% if todo.completed %}todo-completed{% endif %}">{{ todo.task
                                }}</span>
                        </div>
                        <div>
                            <span class="delete-todo-btn" title="Delete"><i class="fas fa-trash-alt"></i></span>
                        </div>
                    </li>
                    {% endfor %}
                </ul>

                <div class="card-footer bg-transparent mt-4">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted"><span id="items-left">{{ todos|selectattr('completed', 'equalto',
                                false)|list|length }}</span> items left</small>
                        <button id="clear-completed" class="btn btn-sm btn-outline-danger">Clear completed</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Documentation Card -->
<div class="row justify-content-center mt-4 animate__animated animate__fadeIn animate__delay-1s">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h3 class="mb-0"><i class="fas fa-server me-2"></i>Todo API Documentation</h3>
            </div>
            <div class="card-body">
                <h5>Available Endpoints:</h5>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>URL</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge bg-success">GET</span></td>
                            <td><code>/api/todos</code></td>
                            <td>Get all todos</td>
                        </tr>
                        <tr>
                            <td><span class="badge bg-primary">POST</span></td>
                            <td><code>/api/todos</code></td>
                            <td>Create a new todo</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const todoList = document.getElementById('todo-list');
        const addTodoForm = document.getElementById('add-todo-form');
        const newTodoInput = document.getElementById('new-todo');
        const itemsLeftEl = document.getElementById('items-left');
        const filterAll = document.getElementById('filter-all');
        const filterActive = document.getElementById('filter-active');
        const filterCompleted = document.getElementById('filter-completed');
        const clearCompleted = document.getElementById('clear-completed');

        // Add new todo
        addTodoForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const task = newTodoInput.value.trim();
            if (!task) return;

            // Send POST request to create todo
            fetch('/api/todos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task: task }),
            })
                .then(response => response.json())
                .then(todo => {
                    // Create new todo item
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center todo-item';
                    li.dataset.id = todo.id;

                    li.innerHTML = `
                    <div>
                        <input class="form-check-input me-2 todo-checkbox" type="checkbox">
                        <span class="todo-text">${todo.task}</span>
                    </div>
                    <div>
                        <span class="delete-todo-btn" title="Delete"><i class="fas fa-trash-alt"></i></span>
                    </div>
                `;

                    todoList.appendChild(li);
                    newTodoInput.value = '';
                    updateItemsLeft();

                    // Add event listeners to new elements
                    setupEventListeners(li);
                });
        });

        // Delete todo
        function setupEventListeners(item) {
            // If item is not provided, setup for all items
            const items = item ? [item] : document.querySelectorAll('.todo-item');

            items.forEach(li => {
                const deleteBtn = li.querySelector('.delete-todo-btn');
                const checkbox = li.querySelector('.todo-checkbox');

                // Delete todo
                deleteBtn.addEventListener('click', function () {
                    // Animate removal
                    li.classList.add('animate__animated', 'animate__fadeOutRight');
                    li.addEventListener('animationend', function () {
                        li.remove();
                        updateItemsLeft();
                    });
                });

                // Toggle completion status
                checkbox.addEventListener('change', function () {
                    const todoText = li.querySelector('.todo-text');
                    todoText.classList.toggle('todo-completed', this.checked);
                    updateItemsLeft();
                });
            });
        }

        // Set up event listeners for existing todos
        setupEventListeners();

        // Filter todos
        filterAll.addEventListener('click', function () {
            document.querySelectorAll('.todo-item').forEach(item => {
                item.style.display = 'flex';
            });
            setActiveFilter(filterAll);
        });

        filterActive.addEventListener('click', function () {
            document.querySelectorAll('.todo-item').forEach(item => {
                const isCompleted = item.querySelector('.todo-checkbox').checked;
                item.style.display = isCompleted ? 'none' : 'flex';
            });
            setActiveFilter(filterActive);
        });

        filterCompleted.addEventListener('click', function () {
            document.querySelectorAll('.todo-item').forEach(item => {
                const isCompleted = item.querySelector('.todo-checkbox').checked;
                item.style.display = isCompleted ? 'flex' : 'none';
            });
            setActiveFilter(filterCompleted);
        });

        function setActiveFilter(activeBtn) {
            [filterAll, filterActive, filterCompleted].forEach(btn => {
                btn.classList.remove('btn-info', 'text-white');
                btn.classList.add('btn-outline-secondary');
            });

            activeBtn.classList.remove('btn-outline-secondary');
            activeBtn.classList.add('btn-info', 'text-white');
        }

        // Clear completed
        clearCompleted.addEventListener('click', function () {
            document.querySelectorAll('.todo-item').forEach(item => {
                const isCompleted = item.querySelector('.todo-checkbox').checked;
                if (isCompleted) {
                    item.classList.add('animate__animated', 'animate__fadeOut');
                    item.addEventListener('animationend', function () {
                        item.remove();
                    });
                }
            });
        });

        // Update items left count
        function updateItemsLeft() {
            const itemsLeft = document.querySelectorAll('.todo-checkbox:not(:checked)').length;
            itemsLeftEl.textContent = itemsLeft;
        }

        // Initial call
        updateItemsLeft();

        // Set "All" as default active filter
        setActiveFilter(filterAll);
    });
</script>
{% endblock %}